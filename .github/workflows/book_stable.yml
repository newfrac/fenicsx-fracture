name: Build Jupyter Book

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]

env:
  HDF5_MPI: "ON"
  HDF5_DIR: "/usr/local/"
  DISPLAY: ":99.0"
  DEB_PYTHON_INSTALL_LAYOUT: deb_system
  PYVISTA_TRAME_SERVER_PROXY_PREFIX: '/proxy/'
  PYVISTA_TRAME_SERVER_PROXY_ENABLED: "True"
  PYVISTA_OFF_SCREEN: false
  PYVISTA_JUPYTER_BACKEND: "html"

jobs:
  build-book:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter-book==0.13.1
          # Use the repository root requirements.txt (fall back to docker/requirements.txt if present)
          if [ -f "requirements.txt" ]; then
            echo "Installing from requirements.txt"
            pip install -r requirements.txt
          elif [ -f "docker/requirements.txt" ]; then
            echo "Installing from docker/requirements.txt"
            pip install -r docker/requirements.txt
          else
            echo "❌ No requirements file found at requirements.txt or docker/requirements.txt"
            ls -la
            exit 1
          fi

      - name: Debug directory structure
        run: |
          echo "Current working directory: $(pwd)"
          echo "Root files:"
          ls -la
          echo "Docker directory contents:"
          if [ -d "docker" ]; then
            ls -la docker || true
            find docker -maxdepth 2 -type f -print || true
          else
            echo "docker directory not present"
          fi
          echo "Notebooks folders:"
          find notebooks -type d || true
          find notebooks -type l || true

      - name: Check Jupyter Book config
        run: |
          if [ ! -f "_config.yml" ]; then
            echo "❌ _config.yml not found"
            exit 1
          fi
          if [ ! -f "_toc.yml" ]; then
            echo "❌ _toc.yml not found"
            exit 1
          fi
          echo "✅ Found _config.yml and _toc.yml"

      - name: Clean previous builds
        run: jupyter-book clean .

      - name: Build Jupyter Book in debug mode
        run: jupyter-book build . --debug

      - name: Upload built HTML
        uses: actions/upload-artifact@v4
        with:
          name: book-html
          path: _build/html
          retention-days: 2
