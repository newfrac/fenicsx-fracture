name: Build Jupyter Book

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]

env:
  HDF5_MPI: "ON"
  HDF5_DIR: "/usr/local/"
  DISPLAY: ":99.0"
  DEB_PYTHON_INSTALL_LAYOUT: deb_system
  PYVISTA_TRAME_SERVER_PROXY_PREFIX: '/proxy/'
  PYVISTA_TRAME_SERVER_PROXY_ENABLED: "True"
  PYVISTA_OFF_SCREEN: false
  PYVISTA_JUPYTER_BACKEND: "html"

jobs:
  build-book:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter-book==0.13.1
          pip install -r docker/requirements.txt

      - name: Debug directory structure
        run: |
          echo "Current working directory: $(pwd)"
          ls -la
          echo "Notebooks folders:"
          find notebooks -type d
          find notebooks -type l
          echo "Root files:"
          ls -la

      - name: Check Jupyter Book config
        run: |
          if [ ! -f "_config.yml" ]; then
            echo "❌ _config.yml not found"
            exit 1
          fi
          if [ ! -f "_toc.yml" ]; then
            echo "❌ _toc.yml not found"
            exit 1
          fi
          echo "✅ Found _config.yml and _toc.yml"

      - name: Clean previous builds
        run: jupyter-book clean .

      - name: Build Jupyter Book
        run: jupyter-book build .

      - name: Upload built HTML
        uses: actions/upload-artifact@v4
        with:
          name: webpage
          path: _build/html
          retention-days: 2

      # Optional: deploy to GitHub Pages
      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v7
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./_build/html
